<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON æ¸¸æˆæ–‡ä»¶éªŒè¯å™¨</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
            color: #1e293b;
            line-height: 1.6;
        }
        .header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 30px;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
        .panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        .file-input-area {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .file-input-area:hover {
            border-color: #6366f1;
            background: #f8fafc;
        }
        .file-input-area.dragover {
            border-color: #6366f1;
            background: #e0e7ff;
        }
        textarea {
            width: 100%;
            min-height: 400px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: 'SF Mono', Monaco, 'Consolas', monospace;
            font-size: 14px;
            resize: vertical;
        }
        .btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 5px;
        }
        .btn:hover {
            background: #5558e3;
            transform: translateY(-1px);
        }
        .btn.secondary {
            background: #64748b;
        }
        .btn.secondary:hover {
            background: #475569;
        }
        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
        }
        .result.success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
        }
        .result.error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
        }
        .result.info {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #1e40af;
        }
        .checklist {
            list-style: none;
            padding: 0;
        }
        .checklist li {
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        .checklist li:last-child {
            border-bottom: none;
        }
        .checklist .pass::before {
            content: "âœ… ";
            color: #22c55e;
            font-weight: bold;
        }
        .checklist .fail::before {
            content: "âŒ ";
            color: #ef4444;
            font-weight: bold;
        }
        .checklist .warn::before {
            content: "âš ï¸ ";
            color: #f59e0b;
            font-weight: bold;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #6366f1;
            text-decoration: none;
            font-weight: 600;
        }
        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">â† è¿”å›æ¸¸æˆ</a>
    
    <div class="header">
        <h1>ğŸ” JSON æ¸¸æˆæ–‡ä»¶éªŒè¯å™¨</h1>
        <p>éªŒè¯å’Œè°ƒè¯•ä½ çš„ Text Engine æ¸¸æˆæ–‡ä»¶</p>
    </div>

    <div class="container">
        <div class="panel">
            <h2>ğŸ“ é€‰æ‹©æ–‡ä»¶</h2>
            <div class="file-input-area" id="fileDropArea">
                <p>ğŸ“‚ æ‹–æ‹½JSONæ–‡ä»¶åˆ°è¿™é‡Œï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                <input type="file" id="fileInput" accept=".json,application/json" style="display: none;">
            </div>
            <div style="margin-top: 20px;">
                <button class="btn" onclick="validateFile()">ğŸ” éªŒè¯æ–‡ä»¶</button>
                <button class="btn secondary" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©º</button>
            </div>
        </div>

        <div class="panel">
            <h2>ğŸ“ JSON å†…å®¹</h2>
            <textarea id="jsonContent" placeholder="ä½ ä¹Ÿå¯ä»¥ç›´æ¥åœ¨è¿™é‡Œç²˜è´´JSONå†…å®¹è¿›è¡ŒéªŒè¯..."></textarea>
            <div style="margin-top: 15px;">
                <button class="btn" onclick="validateText()">âœ… éªŒè¯æ–‡æœ¬</button>
                <button class="btn secondary" onclick="formatJson()">ğŸ¨ æ ¼å¼åŒ–</button>
                <button class="btn secondary" onclick="loadExample()">ğŸ“¥ åŠ è½½ç¤ºä¾‹</button>
                <button class="btn" onclick="convertToStandard()" style="background: #10b981;">ğŸ”„ è½¬æ¢æˆæ ‡å‡†ç‰ˆJSON</button>
            </div>
        </div>
    </div>

    <div class="panel" id="resultPanel" style="display: none;">
        <h2>ğŸ“Š éªŒè¯ç»“æœ</h2>
        <div id="resultContent"></div>
    </div>

    <script>
        let currentData = null;

        // File input handling
        const fileInput = document.getElementById('fileInput');
        const fileDropArea = document.getElementById('fileDropArea');
        const jsonContent = document.getElementById('jsonContent');
        const resultPanel = document.getElementById('resultPanel');
        const resultContent = document.getElementById('resultContent');

        // Click to select file
        fileDropArea.addEventListener('click', () => fileInput.click());

        // Drag and drop handling
        fileDropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileDropArea.classList.add('dragover');
        });

        fileDropArea.addEventListener('dragleave', () => {
            fileDropArea.classList.remove('dragover');
        });

        fileDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        // File selection handling
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.json')) {
                showResult('error', 'è¯·é€‰æ‹©JSONæ–‡ä»¶');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                jsonContent.value = e.target.result;
                showResult('info', `æ–‡ä»¶ "${file.name}" å·²åŠ è½½ (${(file.size / 1024).toFixed(2)} KB)`);
            };
            reader.readAsText(file);
        }

        function validateFile() {
            if (!fileInput.files.length) {
                showResult('error', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶');
                return;
            }
            validateText();
        }

        function validateText() {
            const content = jsonContent.value.trim();
            
            if (!content) {
                showResult('error', 'è¯·è¾“å…¥JSONå†…å®¹');
                return;
            }

            try {
                currentData = JSON.parse(content);
                performValidation(currentData);
            } catch (error) {
                showResult('error', `JSONè§£æé”™è¯¯: ${error.message}`);
            }
        }

        function performValidation(data) {
            const checks = [];
            let hasErrors = false;
            let hasWarnings = false;

            // Basic structure checks
            if (!data || typeof data !== 'object') {
                checks.push({ status: 'fail', message: 'JSONå¿…é¡»æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„å¯¹è±¡' });
                hasErrors = true;
            } else {
                checks.push({ status: 'pass', message: 'JSONæ ¼å¼æ­£ç¡®' });
            }

            // Check rooms
            if (!data.rooms) {
                checks.push({ status: 'fail', message: 'ç¼ºå°‘roomså­—æ®µ' });
                hasErrors = true;
            } else if (!Array.isArray(data.rooms)) {
                checks.push({ status: 'fail', message: 'roomså¿…é¡»æ˜¯æ•°ç»„' });
                hasErrors = true;
            } else if (data.rooms.length === 0) {
                checks.push({ status: 'fail', message: 'roomsæ•°ç»„ä¸èƒ½ä¸ºç©º' });
                hasErrors = true;
            } else {
                checks.push({ status: 'pass', message: `åŒ…å«${data.rooms.length}ä¸ªæˆ¿é—´` });
                
                // Check each room
                data.rooms.forEach((room, index) => {
                    if (!room.id) {
                        checks.push({ status: 'fail', message: `æˆ¿é—´${index + 1}ç¼ºå°‘idå­—æ®µ` });
                        hasErrors = true;
                    }
                    if (!room.name) {
                        checks.push({ status: 'fail', message: `æˆ¿é—´${index + 1}ç¼ºå°‘nameå­—æ®µ` });
                        hasErrors = true;
                    }
                    if (!room.desc) {
                        checks.push({ status: 'warn', message: `æˆ¿é—´${index + 1}ç¼ºå°‘descå­—æ®µ` });
                        hasWarnings = true;
                    } else if (!Array.isArray(room.desc)) {
                        checks.push({ status: 'warn', message: `æˆ¿é—´${index + 1}çš„descåº”è¯¥æ˜¯æ•°ç»„` });
                        hasWarnings = true;
                    }
                });
            }

            // Check playerId
            if (!data.playerId) {
                checks.push({ status: 'warn', message: 'å»ºè®®æ·»åŠ playerIdå­—æ®µæŒ‡å®šèµ·å§‹æˆ¿é—´' });
                hasWarnings = true;
            } else {
                const playerRoom = data.rooms ? data.rooms.find(r => r.id === data.playerId) : null;
                if (!playerRoom) {
                    checks.push({ status: 'fail', message: `playerId "${data.playerId}" å¯¹åº”çš„æˆ¿é—´ä¸å­˜åœ¨` });
                    hasErrors = true;
                } else {
                    checks.push({ status: 'pass', message: `ç©å®¶èµ·å§‹æˆ¿é—´: ${data.playerId}` });
                }
            }

            // Check characters
            if (data.characters && data.characters.length > 0) {
                checks.push({ status: 'pass', message: `åŒ…å«${data.characters.length}ä¸ªè§’è‰²` });
                
                data.characters.forEach((char, index) => {
                    if (!char.id) {
                        checks.push({ status: 'warn', message: `è§’è‰²${index + 1}ç¼ºå°‘idå­—æ®µ` });
                        hasWarnings = true;
                    }
                    if (!char.name) {
                        checks.push({ status: 'warn', message: `è§’è‰²${index + 1}ç¼ºå°‘nameå­—æ®µ` });
                        hasWarnings = true;
                    }
                });
            }

            // Display results
            const resultType = hasErrors ? 'error' : (hasWarnings ? 'info' : 'success');
            const resultTitle = hasErrors ? 'âŒ éªŒè¯å¤±è´¥' : (hasWarnings ? 'âš ï¸ éªŒè¯é€šè¿‡ï¼ˆæœ‰è­¦å‘Šï¼‰' : 'âœ… éªŒè¯é€šè¿‡');
            
            let html = `<h3>${resultTitle}</h3>`;
            html += '<ul class="checklist">';
            checks.forEach(check => {
                html += `<li class="${check.status}">${check.message}</li>`;
            });
            html += '</ul>';

            if (!hasErrors) {
                html += `
                    <div style="margin-top: 20px;">
                        <h4>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h4>
                        <p>æˆ¿é—´æ•°é‡: ${data.rooms ? data.rooms.length : 0}</p>
                        <p>è§’è‰²æ•°é‡: ${data.characters ? data.characters.length : 0}</p>
                        <p>ç©å®¶èµ·å§‹: ${data.playerId || 'æœªæŒ‡å®š'}</p>
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="btn" onclick="downloadFixedJson()">ğŸ“¥ ä¸‹è½½ä¿®å¤åçš„JSON</button>
                        <button class="btn secondary" onclick="testInGame()">ğŸ® åœ¨æ¸¸æˆä¸­æµ‹è¯•</button>
                    </div>
                `;
            }

            showResult(resultType, html);
        }

        function showResult(type, content) {
            resultPanel.style.display = 'block';
            resultContent.innerHTML = `<div class="result ${type}">${content}</div>`;
            resultPanel.scrollIntoView({ behavior: 'smooth' });
        }

        function formatJson() {
            try {
                const content = jsonContent.value.trim();
                if (!content) {
                    showResult('error', 'è¯·å…ˆè¾“å…¥JSONå†…å®¹');
                    return;
                }
                const data = JSON.parse(content);
                jsonContent.value = JSON.stringify(data, null, 2);
                showResult('success', 'JSONå·²æ ¼å¼åŒ–');
            } catch (error) {
                showResult('error', `æ ¼å¼åŒ–å¤±è´¥: ${error.message}`);
            }
        }

        function loadExample() {
            const example = {
                "playerName": "ç¤ºä¾‹ç©å®¶",
                "rooms": [
                    {
                        "id": "start",
                        "name": "èµ·å§‹æˆ¿é—´",
                        "desc": ["è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹æˆ¿é—´ã€‚"],
                        "exits": [{"dir": ["åŒ—", "north"], "id": "start"}]
                    }
                ],
                "playerId": "start"
            };
            jsonContent.value = JSON.stringify(example, null, 2);
            showResult('info', 'ç¤ºä¾‹JSONå·²åŠ è½½');
        }

        function clearAll() {
            jsonContent.value = '';
            fileInput.value = '';
            resultPanel.style.display = 'none';
            currentData = null;
        }

        function downloadFixedJson() {
            if (!currentData) {
                showResult('error', 'æ²¡æœ‰å¯ä¸‹è½½çš„æ•°æ®');
                return;
            }
            
            const json = JSON.stringify(currentData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'validated-game.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function testInGame() {
            if (!currentData) {
                showResult('error', 'æ²¡æœ‰å¯åŠ è½½çš„æ¸¸æˆæ•°æ®');
                return;
            }
            
            try {
                localStorage.setItem('importedGameData', JSON.stringify(currentData));
                window.open('index.html', '_blank');
                showResult('success', 'æ¸¸æˆæ•°æ®å·²ä¿å­˜ï¼Œå°†åœ¨æ–°çª—å£ä¸­åŠ è½½æ¸¸æˆ');
            } catch (error) {
                showResult('error', 'ä¿å­˜æ¸¸æˆæ•°æ®å¤±è´¥ï¼š' + error.message);
            }
        }

        function convertToStandard() {
            const content = jsonContent.value.trim();
            
            if (!content) {
                showResult('error', 'è¯·å…ˆè¾“å…¥JSONå†…å®¹');
                return;
            }

            try {
                const data = JSON.parse(content);
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯æ ‡å‡†æ ¼å¼
                if (data.scenes && data.start) {
                    showResult('info', 'JSONå·²ç»æ˜¯æ ‡å‡†æ ¼å¼ï¼Œæ— éœ€è½¬æ¢');
                    return;
                }

                // è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼
                const standardData = {
                    start: data.playerId || (data.rooms && data.rooms[0] ? data.rooms[0].id : 'start'),
                    scenes: {}
                };

                // è½¬æ¢roomsåˆ°scenes
                if (data.rooms && Array.isArray(data.rooms)) {
                    data.rooms.forEach(room => {
                        standardData.scenes[room.id] = {
                            id: room.id,
                            name: room.name || 'æœªå‘½ååœºæ™¯',
                            desc: Array.isArray(room.desc) ? room.desc.join('\n\n') : (room.desc || ''),
                            img: room.img || '',
                            exits: room.exits || [],
                            items: room.items || []
                        };
                    });
                }

                // æ›´æ–°æ–‡æœ¬æ¡†
                jsonContent.value = JSON.stringify(standardData, null, 2);
                currentData = standardData;

                // æ˜¾ç¤ºè½¬æ¢ç»“æœ
                let html = '<h3>âœ… è½¬æ¢æˆåŠŸ</h3>';
                html += '<ul class="checklist">';
                html += '<li class="pass">å·²å°†roomsè½¬æ¢ä¸ºscenes</li>';
                html += '<li class="pass">å·²å°†playerIdè½¬æ¢ä¸ºstart</li>';
                html += '<li class="pass">å·²å°†descæ•°ç»„è½¬æ¢ä¸ºå­—ç¬¦ä¸²</li>';
                html += '</ul>';
                html += `
                    <div style="margin-top: 20px;">
                        <h4>ğŸ“Š è½¬æ¢ç»Ÿè®¡</h4>
                        <p>åœºæ™¯æ•°é‡: ${Object.keys(standardData.scenes).length}</p>
                        <p>èµ·å§‹åœºæ™¯: ${standardData.start}</p>
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="btn" onclick="downloadStandardJson()">ğŸ“¥ ä¸‹è½½æ ‡å‡†ç‰ˆJSON</button>
                        <button class="btn" onclick="startGame()" style="background: #f59e0b;">ğŸ® ä¸€é”®å¼€å§‹æ¸¸æˆ</button>
                    </div>
                `;

                showResult('success', html);
            } catch (error) {
                showResult('error', `è½¬æ¢å¤±è´¥: ${error.message}`);
            }
        }

        function downloadStandardJson() {
            if (!currentData) {
                showResult('error', 'æ²¡æœ‰å¯ä¸‹è½½çš„æ•°æ®');
                return;
            }
            
            const json = JSON.stringify(currentData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'standard-game.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function startGame() {
            if (!currentData) {
                showResult('error', 'æ²¡æœ‰å¯åŠ è½½çš„æ¸¸æˆæ•°æ®');
                return;
            }

            // å°†æ¸¸æˆæ•°æ®ä¿å­˜åˆ°localStorage
            localStorage.setItem('importedGameData', JSON.stringify(currentData));
            
            // æ‰“å¼€æ¸¸æˆé¡µé¢
            window.open('index.html', '_blank');
            
            showResult('success', 'æ¸¸æˆæ•°æ®å·²ä¿å­˜ï¼Œå°†åœ¨æ–°çª—å£ä¸­åŠ è½½æ¸¸æˆ');
        }
    </script>
</body>
</html>