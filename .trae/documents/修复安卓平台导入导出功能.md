# 修复安卓平台导入导出功能计划

## 🎯 目标
确保所有导入导出按钮在安卓平台上正常工作，包括文件上传、下载、ZIP压缩解压等功能。

## 📋 发现的主要问题

### 高优先级问题
1. **URL.createObjectURL 在移动端不稳定**
   - 位置：所有导出功能（game-editor、enhanced-editor、studio、game-library）
   - 问题：移动浏览器可能不支持或内存泄漏
   - 影响：文件下载失败

2. **JSZip 大文件解压阻塞UI**
   - 位置：game-importer.ts
   - 问题：大文件解压导致应用卡顿或崩溃
   - 影响：ZIP导入失败

3. **Blob API 兼容性问题**
   - 位置：所有导出功能
   - 问题：某些旧版移动浏览器支持不完整
   - 影响：文件导出失败

### 中优先级问题
4. **Capacitor Filesystem API 未充分利用**
   - 位置：mobile-native.ts
   - 问题：Web端降级到localStorage，功能受限
   - 影响：无法访问设备文件系统

5. **文件大小限制不一致**
   - 位置：多个文件（10MB、50MB等）
   - 问题：用户体验不一致
   - 影响：用户困惑

6. **Base64压缩效率低**
   - 位置：game-library-backup.ts
   - 问题：文件大小增加33%
   - 影响：备份文件过大

## 🔧 修复方案

### 1. 创建跨平台文件下载工具
**文件**: `src/lib/platform-file-download.ts`
- 检测平台（Web/Android/iOS）
- Web端：使用Blob + URL.createObjectURL + fallback
- 原生端：使用Capacitor Filesystem API
- 添加错误处理和重试机制

### 2. 优化JSZip使用
**文件**: `src/lib/game-importer.ts`
- 使用Web Worker进行后台解压
- 添加进度回调
- 限制内存使用
- 添加超时处理

### 3. 创建跨平台文件上传工具
**文件**: `src/lib/platform-file-upload.ts`
- 检测平台
- Web端：使用FileReader + FormData
- 原生端：使用Capacitor File API
- 添加进度回调

### 4. 统一文件大小限制配置
**文件**: `src/lib/file-config.ts`
- 定义统一的文件大小限制
- 导出配置常量
- 添加验证函数

### 5. 替换Base64压缩
**文件**: `src/lib/game-library-backup.ts`
- 使用pako库进行真正的压缩
- 添加压缩级别配置
- 保持向后兼容

### 6. 更新所有导出功能
**文件**: 
- `src/app/game-editor/page.tsx`
- `src/app/enhanced-editor/page.tsx`
- `src/app/studio/page.tsx`
- `src/app/game-library/page.tsx`
- `src/components/ui/backup-restore.tsx`

**修改内容**:
- 使用新的跨平台下载工具
- 添加进度反馈
- 改进错误处理
- 添加成功提示

### 7. 更新所有导入功能
**文件**:
- `src/app/game-editor/page.tsx`
- `src/app/enhanced-editor/page.tsx`
- `src/app/studio/page.tsx`
- `src/app/game-library/page.tsx`
- `src/components/file-upload.tsx`

**修改内容**:
- 使用新的跨平台上传工具
- 添加进度反馈
- 改进错误处理
- 添加文件验证

### 8. 添加进度指示器组件
**文件**: `src/components/ui/progress-indicator.tsx`
- 显示文件操作进度
- 支持取消操作
- 显示速度和剩余时间

## 📦 需要安装的依赖
```bash
npm install pako @capacitor/filesystem @capacitor/share
```

## ✅ 验证清单
- [ ] 单个JSON文件导出
- [ ] 批量ZIP文件导出
- [ ] 单个JSON文件导入
- [ ] 批量ZIP文件导入
- [ ] 备份文件导出
- [ ] 备份文件导入
- [ ] 图片上传
- [ ] 大文件处理（>10MB）
- [ ] 错误处理和用户反馈
- [ ] 进度显示

## 🔄 测试计划
1. 在Chrome浏览器测试Web端功能
2. 在Android模拟器测试原生功能
3. 在真实Android设备测试
4. 测试大文件（50MB+）
5. 测试网络中断情况
6. 测试存储空间不足情况