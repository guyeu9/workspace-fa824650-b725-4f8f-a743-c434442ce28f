# 游戏存档转换计划

## 📋 任务概述

将 `游戏2.0版本月王故事.json` 转换为符合最新游戏编辑器格式的存档，支持 `end_game` 字段和场景跳转优化。

## 🔍 现状分析

### 原始文件问题

1. **数据结构过时**：使用旧格式（`roomId`, `rooms`, `exits`, `dir`）
2. **场景数量过多**：20+个场景，结构复杂
3. **缺少新字段**：没有 `end_game`, `next_branch`, `status_changes` 等新特性
4. **强制跳转**：所有选项都必须跳转到新场景，无法支持结束游戏

### 游戏编辑器新特性

* ✅ `end_game`: 布尔值，标记选项是否结束游戏

* ✅ `next_branch`: 字符串，指定跳转目标（可为空）

* ✅ `status_changes`: 数组，支持复杂的数值变更操作

* ✅ `effect`: 字符串，选项效果描述

* ✅ `status_update`: 字符串，状态更新描述

## 🎯 转换策略

### 1. 数据结构转换

* `roomId` → `game_title`

* `rooms` → `branches`

* `id` → `branch_id`

* `name` → `chapter`

* `desc` → `scene_detail`

* `exits` → `choices`

* `dir` → `choice`

* `id` (exit) → `next_branch`

### 2. 场景优化策略

**合并相似场景**：

* 将 `SMOON_CAUTIOUS` 和 `SMOON_RESIST` 合并为一个场景

* 将 `SMOON_SURRENDER` 和 `SMOON_ADAPT` 合并为一个场景

* 将 `SMOON_SPECIAL_MOD` 和 `SMOON_SPECIAL_PRISON` 合并为一个场景

**添加** **`end_game`** **支持**：

* 结局场景（`SMOON_FULL_CORRUPTION_END`, `SMOON_DOMINATOR_END`）的选项设置 `end_game: true`

* 允许某些选项不跳转（`next_branch: ""`）

### 3. 状态系统转换

将 `effects.onEnter` 和 `conditions.effects` 转换为 `status_changes` 格式：

```javascript
// 原始格式
"effects": {
  "onEnter": {
    "desire": 5,
    "message": "办公室的雄性气息让你心跳加速"
  }
}

// 转换为
"status_changes": [
  {
    "attribute": "desire",
    "operation": "+",
    "value": 5
  }
]
```

### 4. 条件系统转换

将 `conditions.required` 转换为选项的 `status_changes` 中的条件检查：

* 移除硬编码的条件检查

* 使用 `status_changes` 动态调整状态

## 📝 具体转换步骤

### 步骤1：基础结构转换

创建新的游戏数据结构，包含：

* `game_title`: "月王故事"

* `description`: "一个关于卧底孢魔岛的冒险故事"

* `game_states`: 定义 `desire`, `corruption`, `resistance` 等状态

* `branches`: 转换后的场景列表

### 步骤2：场景转换（优化后约12-15个场景）

1. **SMOON\_START** → 保留，添加 `end_game` 选项
2. **SMOON\_PREPARATION** → 保留
3. **SMOON\_SHIP** → 保留
4. **SMOON\_CAUTIOUS** → 合并到 SMOON\_SHIP
5. **SMOON\_BOLD** → 保留
6. **SMOON\_RESIST** → 合并到 SMOON\_CAUTIOUS
7. **SMOON\_SURRENDER** → 合并到 SMOON\_RESIST
8. **SMOON\_ADAPT** → 合并到 SMOON\_SURRENDER
9. **SMOON\_SPECIAL\_MOD** → 合并到 SMOON\_BOLD
10. **SMOON\_SPECIAL\_PRISON** → 合并到 SMOON\_SPECIAL\_MOD
11. **SMOON\_CONTRIBUTE** → 保留
12. **SMOON\_HUNT\_WAN** → 保留
13. **SMOON\_BROTHERS** → 保留
14. **SMOON\_PREHEAT\_BRANCH** → 保留
15. **SMOON\_PRIEST\_EARLY** → 保留
16. **SMOON\_FINAL** → 保留
17. **SMOON\_ALTAR** → 合并到 SMOON\_FINAL
18. **SMOON\_FINAL\_FALL** → 合并到 SMOON\_FINAL
19. **SMOON\_FULL\_CORRUPTION\_END** → 保留，设置 `end_game: true`
20. **SMOON\_DOMINATOR\_END** → 保留，设置 `end_game: true`
21. **SMOON\_REFUSE\_END** → 保留，设置 `end_game: true`

### 步骤3：选项转换

为每个场景的选项添加新字段：

* `end_game`: 结局场景的选项设为 `true`

* `next_branch`: 设置正确的跳转目标

* `status_changes`: 转换数值变更

* `effect`: 保留或创建效果描述

* `status_update`: 保留或创建状态更新描述

### 步骤4：验证和测试

* 检查所有 `next_branch` 引用是否有效

* 确保 `end_game` 选项正确设置

* 验证 `status_changes` 格式正确

* 测试游戏导入和运行

## 📊 预期结果

### 转换后结构

```json
{
  "game_title": "月王故事",
  "description": "一个关于卧底孢魔岛的冒险故事",
  "game_states": [
    {
      "name": "desire",
      "initial_value": 0,
      "min": 0,
      "max": 100,
      "is_percentage": true
    },
    {
      "name": "corruption",
      "initial_value": 0,
      "min": 0,
      "max": 100,
      "is_percentage": true
    },
    {
      "name": "resistance",
      "initial_value": 0,
      "min": 0,
      "max": 100,
      "is_percentage": true
    }
  ],
  "branches": [
    {
      "branch_id": "SMOON_START",
      "chapter": "皇庭办公室 - 任务抉择",
      "scene_detail": "宽敞明亮的魔能枪械团团长办公室...",
      "choices": [
        {
          "id": "choice_1",
          "choice": "接受任务",
          "next_branch": "SMOON_PREPARATION",
          "effect": "接受任务让你内心涌起隐秘的兴奋",
          "status_update": "接受任务让你内心涌起隐秘的兴奋",
          "status_changes": [
            {
              "attribute": "corruption",
              "operation": "+",
              "value": 10
            },
            {
              "attribute": "desire",
              "operation": "+",
              "value": 15
            }
          ]
        },
        {
          "id": "choice_2",
          "choice": "拒绝任务",
          "next_branch": "SMOON_REFUSE_END",
          "effect": "你选择了坚守原则，但内心隐隐遗憾",
          "status_update": "你选择了坚守原则，但内心隐隐遗憾",
          "status_changes": [
            {
              "attribute": "resistance",
              "operation": "+",
              "value": 20
            }
          ]
        }
      ]
    }
    // ... 其他分支
  ]
}
```

### 优化效果

* ✅ 场景数量从 20+ 优化到约 12-15 个

* ✅ 支持 `end_game` 字段，允许游戏自然结束

* ✅ 支持选项不跳转（`next_branch: ""`）

* ✅ 完整的状态系统支持

* ✅ 兼容最新的游戏编辑器

* ✅ 可以正常导入和运行

## ⚠️ 注意事项

1. 保留原有的故事内容和剧情逻辑
2. 确保所有状态变更正确转换
3. 维持原有的游戏平衡性
4. 保留支线故事（如沼泽周末、脑部预热）
5. 确保结局场景正确设置 `end_game: true`

