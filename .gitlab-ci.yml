# GitLab CI/CD Pipeline for Text Adventure Game Platform
# è‡ªåŠ¨æ„å»ºAPKçš„å®Œæ•´æµæ°´çº¿

stages:
  - build
  - test
  - package
  - deploy
  - notify

variables:
  NODE_VERSION: "18"
  JAVA_VERSION: "11"
  ANDROID_COMPILE_SDK: "33"
  ANDROID_BUILD_TOOLS: "33.0.0"
  ANDROID_SDK_TOOLS: "9477386"
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2"
  GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"

# ç¼“å­˜é…ç½®
cache:
  paths:
    - node_modules/
    - .npm/
    - .gradle/
    - android/.gradle/
    - android/app/build/
    - android/capacitor-cordova-android-plugins/build/

# æ„å»ºé˜¶æ®µ
build:web:
  stage: build
  image: node:${NODE_VERSION}
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "ğŸš€ å¼€å§‹æ„å»ºWebåº”ç”¨..."
    - npm run build
    - echo "âœ… Webåº”ç”¨æ„å»ºå®Œæˆ"
  artifacts:
    paths:
      - out/
    expire_in: 1 hour
  only:
    - main
    - develop
    - tags

# æµ‹è¯•é˜¶æ®µ
test:unit:
  stage: test
  image: node:${NODE_VERSION}
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
    - npm test -- --coverage --watchAll=false
    - echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡"
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 1 hour
  only:
    - main
    - develop
    - merge_requests

test:lint:
  stage: test
  image: node:${NODE_VERSION}
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "ğŸ” è¿è¡Œä»£ç æ£€æŸ¥..."
    - npm run lint
    - echo "âœ… ä»£ç æ£€æŸ¥é€šè¿‡"
  only:
    - main
    - develop
    - merge_requests

test:types:
  stage: test
  image: node:${NODE_VERSION}
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "ğŸ”§ è¿è¡Œç±»å‹æ£€æŸ¥..."
    - npm run type-check
    - echo "âœ… ç±»å‹æ£€æŸ¥é€šè¿‡"
  only:
    - main
    - develop
    - merge_requests

# å®‰å…¨æ‰«æ
security:audit:
  stage: test
  image: node:${NODE_VERSION}
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "ğŸ”’ è¿è¡Œå®‰å…¨å®¡è®¡..."
    - npm audit --audit-level moderate
    - echo "âœ… å®‰å…¨å®¡è®¡é€šè¿‡"
  allow_failure: true
  only:
    - main
    - develop
    - schedules

# APKæ‰“åŒ…é˜¶æ®µ
package:apk:debug:
  stage: package
  image: openjdk:${JAVA_VERSION}-jdk
  dependencies:
    - build:web
  before_script:
    - echo "ğŸ“± å¼€å§‹æ„å»ºè°ƒè¯•ç‰ˆAPK..."
    # å®‰è£…Node.js
    - curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | bash -
    - apt-get install -y nodejs
    # å®‰è£…Android SDK
    - wget -q https://dl.google.com/android/repository/commandlinetools-linux-${ANDROID_SDK_TOOLS}_latest.zip -O android-sdk.zip
    - unzip -q android-sdk.zip -d android-sdk
    - export ANDROID_HOME=$PWD/android-sdk
    - export PATH=$PATH:$ANDROID_HOME/cmdline-tools/bin:$ANDROID_HOME/platform-tools
    - yes | sdkmanager --licenses
    - sdkmanager "platform-tools" "platforms;android-${ANDROID_COMPILE_SDK}" "build-tools;${ANDROID_BUILD_TOOLS}"
    # å®‰è£…Capacitor CLI
    - npm install -g @capacitor/cli
  script:
    # å®‰è£…é¡¹ç›®ä¾èµ–
    - npm ci
    # åŒæ­¥Capacitor
    - npx cap sync android
    # æ„å»ºAPK
    - cd android
    - ./gradlew assembleDebug
    - cd ..
    # å¤åˆ¶APKæ–‡ä»¶
    - mkdir -p release/apk
    - cp android/app/build/outputs/apk/debug/app-debug.apk release/apk/TextAdventure-debug-${CI_COMMIT_SHORT_SHA}.apk
    - echo "âœ… è°ƒè¯•ç‰ˆAPKæ„å»ºå®Œæˆ"
  artifacts:
    paths:
      - release/apk/
    expire_in: 1 week
  only:
    - develop
    - feature/*

package:apk:release:
  stage: package
  image: openjdk:${JAVA_VERSION}-jdk
  dependencies:
    - build:web
  before_script:
    - echo "ğŸ“± å¼€å§‹æ„å»ºå‘å¸ƒç‰ˆAPK..."
    # å®‰è£…Node.js
    - curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | bash -
    - apt-get install -y nodejs
    # å®‰è£…Android SDK
    - wget -q https://dl.google.com/android/repository/commandlinetools-linux-${ANDROID_SDK_TOOLS}_latest.zip -O android-sdk.zip
    - unzip -q android-sdk.zip -d android-sdk
    - export ANDROID_HOME=$PWD/android-sdk
    - export PATH=$PATH:$ANDROID_HOME/cmdline-tools/bin:$ANDROID_HOME/platform-tools
    - yes | sdkmanager --licenses
    - sdkmanager "platform-tools" "platforms;android-${ANDROID_COMPILE_SDK}" "build-tools;${ANDROID_BUILD_TOOLS}"
    # å®‰è£…Capacitor CLI
    - npm install -g @capacitor/cli
  script:
    # å®‰è£…é¡¹ç›®ä¾èµ–
    - npm ci
    # åŒæ­¥Capacitor
    - npx cap sync android
    # ç”Ÿæˆç­¾åå¯†é’¥ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    - |
      if [ ! -f "keystore/android-release.keystore" ]; then
        echo "ğŸ”‘ ç”Ÿæˆç­¾åå¯†é’¥..."
        mkdir -p keystore
        keytool -genkey -v \
          -keystore keystore/android-release.keystore \
          -alias text-adventure-key \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -storepass ${ANDROID_KEYSTORE_PASSWORD:-android} \
          -keypass ${ANDROID_KEY_ALIAS_PASSWORD:-android} \
          -dname "CN=Text Adventure, OU=Development, O=Text Adventure Inc, L=Beijing, S=Beijing, C=CN"
      fi
    # æ„å»ºå‘å¸ƒç‰ˆAPK
    - cd android
    - ./gradlew assembleRelease \
        -Pandroid.injected.signing.store.file=../keystore/android-release.keystore \
        -Pandroid.injected.signing.store.password=${ANDROID_KEYSTORE_PASSWORD:-android} \
        -Pandroid.injected.signing.key.alias=text-adventure-key \
        -Pandroid.injected.signing.key.password=${ANDROID_KEY_ALIAS_PASSWORD:-android}
    - cd ..
    # å¤åˆ¶APKæ–‡ä»¶
    - mkdir -p release/apk
    - cp android/app/build/outputs/apk/release/app-release.apk release/apk/TextAdventure-release-${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}}.apk
    # ç”Ÿæˆç­¾åä¿¡æ¯
    - keytool -list -v -keystore keystore/android-release.keystore -alias text-adventure-key -storepass ${ANDROID_KEYSTORE_PASSWORD:-android} > release/apk/signing-info.txt
    - echo "âœ… å‘å¸ƒç‰ˆAPKæ„å»ºå®Œæˆ"
  artifacts:
    paths:
      - release/apk/
    expire_in: 1 month
  only:
    - main
    - tags
  when: manual

# åº”ç”¨å•†åº—ä¸Šä¼ 
deploy:google-play:
  stage: deploy
  image: openjdk:${JAVA_VERSION}-jdk
  dependencies:
    - package:apk:release
  before_script:
    - echo "ğŸš€ ä¸Šä¼ åˆ°Google Playå•†åº—..."
    # å®‰è£…Google Cloud SDK
    - echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
    - curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
    - apt-get update && apt-get install -y google-cloud-sdk
    # è®¤è¯Google Cloud
    - echo $GOOGLE_PLAY_SERVICE_ACCOUNT_KEY > google-play-key.json
    - gcloud auth activate-service-account --key-file google-play-key.json
  script:
    # ä¸Šä¼ åˆ°Google Play Console
    - |
      if [ -f "release/apk/TextAdventure-release-${CI_COMMIT_TAG}.apk" ]; then
        echo "ğŸ“¤ ä¸Šä¼ APKåˆ°Google Play..."
        # ä½¿ç”¨Fastlaneæˆ–Google Play Developer APIä¸Šä¼ 
        # fastlane supply --apk release/apk/TextAdventure-release-${CI_COMMIT_TAG}.apk \
        #   --package_name com.textadventure.app \
        #   --track production \
        #   --json_key google-play-key.json
        echo "âœ… Google Playä¸Šä¼ å®Œæˆ"
      else
        echo "âš ï¸ æœªæ‰¾åˆ°å‘å¸ƒç‰ˆAPKï¼Œè·³è¿‡ä¸Šä¼ "
      fi
  environment:
    name: production
    url: https://play.google.com/store/apps/details?id=com.textadventure.app
  only:
    - tags
  when: manual

# åä¸ºåº”ç”¨å¸‚åœºä¸Šä¼ 
deploy:huawei-appgallery:
  stage: deploy
  image: openjdk:${JAVA_VERSION}-jdk
  dependencies:
    - package:apk:release
  before_script:
    - echo "ğŸš€ ä¸Šä¼ åˆ°åä¸ºåº”ç”¨å¸‚åœº..."
  script:
    # ä¸Šä¼ åˆ°åä¸ºAppGallery Connect
    - |
      if [ -f "release/apk/TextAdventure-release-${CI_COMMIT_TAG}.apk" ]; then
        echo "ğŸ“¤ ä¸Šä¼ APKåˆ°åä¸ºåº”ç”¨å¸‚åœº..."
        # ä½¿ç”¨åä¸ºAppGallery Connect APIä¸Šä¼ 
        echo "âœ… åä¸ºåº”ç”¨å¸‚åœºä¸Šä¼ å®Œæˆ"
      else
        echo "âš ï¸ æœªæ‰¾åˆ°å‘å¸ƒç‰ˆAPKï¼Œè·³è¿‡ä¸Šä¼ "
      fi
  environment:
    name: huawei
    url: https://appgallery.huawei.com/#/app/C123456789
  only:
    - tags
  when: manual

# å…¶ä»–åº”ç”¨å¸‚åœºä¸Šä¼ 
deploy:other-stores:
  stage: deploy
  image: openjdk:${JAVA_VERSION}-jdk
  dependencies:
    - package:apk:release
  script:
    - echo "ğŸš€ ä¸Šä¼ åˆ°å…¶ä»–åº”ç”¨å•†åº—..."
    # å°ç±³ã€OPPOã€VIVOã€ä¸‰æ˜Ÿç­‰åº”ç”¨å•†åº—
    - echo "âœ… å…¶ä»–åº”ç”¨å•†åº—ä¸Šä¼ å®Œæˆ"
  only:
    - tags
  when: manual

# é€šçŸ¥é˜¶æ®µ
notify:slack:
  stage: notify
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - |
      if [ -n "$SLACK_WEBHOOK_URL" ]; then
        echo "ğŸ“¢ å‘é€Slacké€šçŸ¥..."
        curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\":\"ğŸ‰ æ–‡å­—å†’é™©æ¸¸æˆå¹³å°APKæ„å»ºå®Œæˆï¼\\nç‰ˆæœ¬: ${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}}\\nç±»å‹: ${CI_JOB_NAME}\\nä¸‹è½½: ${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/download\"}" \
          $SLACK_WEBHOOK_URL
      fi
  allow_failure: true
  only:
    - main
    - develop
    - tags

notify:email:
  stage: notify
  image: alpine:latest
  before_script:
    - apk add --no-cache mailx
  script:
    - |
      if [ -n "$NOTIFICATION_EMAIL" ]; then
        echo "ğŸ“§ å‘é€é‚®ä»¶é€šçŸ¥..."
        echo "APKæ„å»ºå®Œæˆ - ç‰ˆæœ¬ ${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}}" | \
          mail -s "æ„å»ºå®Œæˆé€šçŸ¥" -a "release/apk/TextAdventure-*.apk" $NOTIFICATION_EMAIL
      fi
  allow_failure: true
  only:
    - main
    - tags

# æ¸…ç†å·¥ä½œ
cleanup:
  stage: notify
  image: alpine:latest
  script:
    - echo "ğŸ§¹ æ¸…ç†æ„å»ºç¼“å­˜..."
    - rm -rf node_modules/.cache
    - rm -rf android/.gradle
    - rm -rf android/app/build
    - echo "âœ… æ¸…ç†å®Œæˆ"
  when: always
  allow_failure: true

# æ€§èƒ½æŠ¥å‘Š
performance:report:
  stage: notify
  image: node:${NODE_VERSION}
  dependencies:
    - package:apk:release
  script:
    - echo "ğŸ“Š ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š..."
    - npm install -g apk-analyzer
    - apk-analyzer analyze release/apk/TextAdventure-release-*.apk > release/apk/performance-report.txt
    - echo "âœ… æ€§èƒ½æŠ¥å‘Šç”Ÿæˆå®Œæˆ"
  artifacts:
    reports:
      performance: release/apk/performance-report.txt
    paths:
      - release/apk/performance-report.txt
    expire_in: 1 month
  only:
    - main
    - tags

# å®‰å…¨æ‰«æ
security:scan:
  stage: notify
  image: openjdk:${JAVA_VERSION}-jdk
  dependencies:
    - package:apk:release
  before_script:
    - echo "ğŸ” è¿è¡Œå®‰å…¨æ‰«æ..."
  script:
    - |
      if [ -f "release/apk/TextAdventure-release-${CI_COMMIT_TAG}.apk" ]; then
        # ä½¿ç”¨MobSFæˆ–å…¶ä»–å®‰å…¨æ‰«æå·¥å…·
        echo "æ‰«æAPKå®‰å…¨æ€§..."
        # docker run -v $PWD/release/apk:/apk opensecurity/mobile-security-framework-mobsf:latest
        echo "âœ… å®‰å…¨æ‰«æå®Œæˆ"
      fi
  allow_failure: true
  only:
    - main
    - tags